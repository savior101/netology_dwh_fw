
## Проектная работа по модулю "DWH"
#### Нетология, курс "Дата-инженер с нуля до middle"
#### Селезенев Антон, группа DEG-17

Задание на выполнение работ в файле _"ТЗ. Проектная работа по модулю "DWH"_.

**Инструменты:** PostgreSQL 12.11, DBeaver Community 22.1.3, [SqlDBM](https://sqldbm.com), Pentaho Data Integration 9.3.0.0-428 (Java 8), Ubuntu 20.04.4 LTS. 

**Этапы реализации:**
1. Проектирование DWH;
2. Разработка DWH;
3. Разработка ETL-процессов;
4. Тестирование, коррекция;
5. Автоматизация выполнения пайплайнов;
6. Написание документации.

**Результат работы:**
+ Проектные ER-диаграммы DWH;
+ SQL-скрипт для развертывания DWH;
+ Трансформации и задания ETL-процессов;
+ Bash-скрипт запуска общей job.

Система производит выгрузку данных из реляционной СУБД, трансформиурет, дополняет, агрегирует, осуществляет проверку качества и записывает в хранилище данных, основанное на СУБД PostgreSQL, для дальнейшей работы с ним с помощью BI инструментов.

#### → Проектирование DWH
За основу принята архитектура Кимбалла: данные из источника в неизменном виде загружаются в stage, затем преобразовываются и загружаются в dds. Построение nds излишне, т.к. исходные данные уже находятся в 3NF. Разработка логической и физической схем выполнена с использованием сервиса SqlDBM.

Схема **stage**.
<p align="center">
  <img width="500" height="350" src="https://thumb.cloud.mail.ru/weblink/thumb/xw1/STBD/Yv8iwjDL7">
</p>

Схема **dds** (dimension data store).
<p align="center">
  <img width="750" height="500" src="https://thumb.cloud.mail.ru/weblink/thumb/xw1/YjSp/VijXMc6xM">
</p>
Измерения dim_aircrafts и dim_airports обладают историчностью (SCD2).

Схема **dq** (data quality).
<p align="center">
  <img width="500" height="350" src="https://thumb.cloud.mail.ru/weblink/thumb/xw1/bHYW/782HTN6RQ">
</p>

Схема **metadata** (метаданные для инъекции).
<p align="center">
  <img width="300" height="200" src="https://thumb.cloud.mail.ru/weblink/thumb/xw1/TuLS/p8QiTg7Rm">
</p>


#### → Разработка DWH
Хранилище данных реализовано на базе PostgreSQL 12. Скрипт развертывания БД содержит DDL создания схем, отношений, индексов, а также наполнение измерения dim_calendar, метаданных для инъекции, а также строк с id=0 в таблицы типа SCD2 для устранения бага Pentaho DI.
Скрипт находится в файле _settings/dwh_bookings.sql_.

#### → Разработка ETL-процессов
Для работы трансформаций необходимо задать переменную окружения ${MAIN_DIR} в kettle.properties, создать и сделать общедоступными подключения к БД источника и dwh, а также задать опцию подключений к БД stringtype=unspecified согласно [треда](https://forums.pentaho.com/threads/133546-ERROR-column-quot-guid-quot-is-of-type-uuid-but-expression-is-of-type-character-varying/) для корректной работы с json-строками.

**Пайплайн загрузки данных из источника в stage** состоит из 3 трансформаций и одного задания ([рассмотреть крупнее](https://thumb.cloud.mail.ru/weblink/thumb/xw1/a75N/Vf1zN3U1E)).

<p align="center">
  <img width="1000" height="400" src="https://thumb.cloud.mail.ru/weblink/thumb/xw1/a75N/Vf1zN3U1E">
</p>

В первой транформации получаем переменные из метаданных для каждой таблицы источника:
+ Название подключения источника;
+ SQL запрос для источника;
+ Название целевого подключения;
+ Название целевой схемы;
+ Название целевой таблицы;
+ Флаг удалять данные перед загрузкой или нет;
+ Последний загруженный в dds.fact_flights flight_id;
+ Последний загруженный в dds.fact_flights ticket_no.

Заменяем переменные flight_id, ticket_no в SQL запросе, а также загружаем оставшиеся метаданные: названия целевых атрибутов и соотвествующих им полей потока, после чего выполняем инъекцию в шаблон, который производит extract-load данных из bookings в stage.

В stage будут храниться только отсутствующие в dds данные из таблиц flights, ticket_flights, tickets источника и все актуальные данные из таблиц aircrafts и airports (это необходимо для отслеживания медленно меняющихся измерений).

**Пайплайн загрузки данных из stage в dds** состоит из 5 транформаций и 1 задания ([рассмотреть крупнее](https://thumb.cloud.mail.ru/weblink/thumb/xw1/88wk/j3N77Kjtp)).

<p align="center">
  <img width="1000" height="600" src="https://thumb.cloud.mail.ru/weblink/thumb/xw1/88wk/j3N77Kjtp">
</p>

Первая транcформация загружает данные из stage.aircrafts, выполняет проверку данных и производит обновление измерения SCD2 dds.dim_aircrafts.
Данные проходят проверку:
+ Код самолета должен состоять только из 3 символов и должен содержать знаки a-z, A-Z, 0-9;
+ Модель самолета должна содержать только знаки a-z, A-Z, пробел, 0-9, -;
+ Дальность полета самолета должна быть положительной.

Записи, не прошедшие проверку, загружаются в таблицу dq.rejected_aircrafts.

Вторая транcформация загружает данные из stage.airports, выполняет проверку данных и производит обновление измерения SCD2 dds.dim_airports.
Данные проходят проверку:
+ Код аэропорта должен состоять только из 3 символов и должен содержать знаки a-z, A-Z, 0-9;
+ Название аэропорта должно содержать только знаки а-я, ё, А-Я, Ё, пробел, -;
+ Название города должно содержать только знаки а-я, ё, А-Я, Ё, пробел, -;
+ Широта должна быть типа данных numeric с разделителем десятичных знаков ".";
+ Долгота должна быть типа данных numeric с разделителем десятичных знаков ".".

Записи, не прошедшие проверку, загружаются в таблицу dq.rejected_airports.

Третья трансформация выбирает уникальные значения класса обслуживания из таблицы stage.ticket_flights, выполняет проверку данных и заносит их в измерение dds.dim_tariffs (при наличии новых записей).
Данные проходят проверку:
+ Класс обслуживания может содержать только знаки a-z, A-Z.

Записи, не прошедшие проверку, загружаются в таблицу dq.rejected_tariffs.

Четвертая транформация загружает данные из stage.tickets, выполняет парсинг json (извлекает телефон и email), проверку данных и заносит их в измерение dds.dim_passengers (при наличии новых записей). Для ускорения трансформации чтение из таблицы делим на 2 потока, парсинг производим на 6 параллельных шагах с последующим объединением строк.
Данные проходят проверку:
+ Длина поля телефон (12 символов);
+ Email должен содержать знак @;
+ Имя и фамилия должны содержать строго латинские буквы, разделенные одним пробелом.

Записи, не прошедшие проверку, загружаются в таблицу dq.rejected_passengers.

Пятая транформация загружает данные из таблиц stage.flights, stage.ticket_flights и stage.tickets, затем объединяет по ключам, заменяет строковые значения на суррогатные ключи измерения dim_tariffs, вычисляет ключи calendar_id для атрибутов actual_departure и actual_arrival, производит проверку данных и заносит их в таблицу фактов dds.fact_flights (при наличии новых записей). Трансформация должна выполняться после успешного выполнения внесения данных в таблицы измерений.
Данные проходят проверку на:
+ Код самолета должен состоять только из 3 символов и должен содержать знаки a-z, A-Z, 0-9;
+ Код аэропорта (как отправления, так и прилета) должен состоять только из 3 симоволв и должен содержать знаки a-z, A-Z, 0-9;
+ ID пассажира должен содержать строго 4 цифры от 0 до 9, один пробел и еще 6 цифр от 0 до 9;
+ Стоимость билета должна состоять из цифр, иметь разделитель "," и два десятичных знака.


Записи, не прошедшие проверку, загружаются в таблицу dq.rejected_flights.

**Оба пайплайна** объединены в одно задание.
<p align="center">
  <img width="600" height="80" src="https://thumb.cloud.mail.ru/weblink/thumb/xw1/M8Wh/TF3y7crdp">
</p>


#### → Автоматизация выполнения пайплайнов

Для автоматизации выполнения задания bash-скрипт _bookings_2_dds.sh_:

```bash
#!/bin/bash
PATH_ETL=<ПУТЬ_ДО_ПАПКИ_С_ЗАДАНИЕМ>
PATH_LOGS=<ПУТЬ_ДО_ПАПКИ_С_ЛОГАМИ>
cd <ПУТЬ_ДО_КОРНЯ_ПАПКИ_PENTAHO>
./kitchen.sh -file:$PATH_ETL/bookings_2_dds.kjb -level:Error -logfile:$PATH_LOGS/bookings_2_dds.log
```